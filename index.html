<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>LIBE IR + Molecule Viewer</title>

  <!-- 3Dmol.js (molecule viewer) -->
  <script src="https://3Dmol.org/build/3Dmol-min.js"></script>

  <!-- Plotly (IR plot) -->
  <script src="https://cdn.plot.ly/plotly-2.30.0.min.js"></script>

  <style>
    body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Arial, sans-serif; margin: 0; }
    header { padding: 14px 18px; border-bottom: 1px solid #ddd; }
    main { display: grid; grid-template-columns: 380px 1fr; gap: 14px; padding: 14px; }
    .panel { border: 1px solid #ddd; border-radius: 10px; padding: 12px; }
    .row { display: flex; gap: 8px; align-items: center; flex-wrap: wrap; }
    label { font-size: 13px; color: #333; }
    input, select, button { padding: 8px 10px; border-radius: 8px; border: 1px solid #ccc; font-size: 14px; }
    button { cursor: pointer; }
    button.primary { border-color: #2b6; }
    .small { font-size: 12px; color: #666; }
    .muted { color: #777; }
    #viewer { width: 100%; height: 430px; border-radius: 10px; border: 1px solid #ddd; }
    #plot { width: 100%; height: 430px; border-radius: 10px; border: 1px solid #ddd; }
    .kvs { display: grid; grid-template-columns: 120px 1fr; gap: 6px 10px; margin-top: 10px; }
    .kvs div { font-size: 13px; }
    .hr { height: 1px; background: #eee; margin: 12px 0; }
    .pill { display: inline-block; padding: 3px 8px; border-radius: 999px; border: 1px solid #ddd; font-size: 12px; color: #444; }
  </style>
</head>

<body>
<header>
  <div class="row" style="justify-content: space-between;">
    <div>
      <div style="font-weight: 700;">LIBE IR + Molecule Viewer</div>
      <div class="small muted">Search by formula (default) or by SMILES + optional charge. View structure and IR spectrum.</div>
    </div>
    <div class="pill" id="statusPill">Loading data…</div>
  </div>
</header>

<main>
  <!-- Left: controls + metadata -->
  <section class="panel">
    <div class="row" style="justify-content: space-between;">
      <div style="font-weight: 600;">Search</div>
      <div class="row">
        <label for="freqScale" class="small">Freq scale</label>
        <input id="freqScale" type="number" step="0.001" min="0.90" max="1.10" value="0.98" style="width: 86px;" />
      </div>
    </div>

    <div class="hr"></div>

    <div class="row">
      <label for="searchMode">Mode</label>
      <select id="searchMode">
        <!-- (2) Default is formula -->
        <option value="formula" selected>Formula</option>
        <option value="smiles">SMILES</option>
      </select>
    </div>

    <div class="hr"></div>

    <!-- Formula search -->
    <div id="formulaBox">
      <div class="row">
        <label for="formulaInput">Formula</label>
        <input id="formulaInput" placeholder="e.g., C3H4O3Li1" style="flex: 1;" />
      </div>
      <div class="row" style="margin-top: 8px;">
        <label for="formulaCharge">Charge (optional)</label>
        <input id="formulaCharge" type="number" step="1" placeholder="e.g., -1" style="width: 120px;" />
      </div>
      <div class="row" style="margin-top: 10px;">
        <button class="primary" id="searchFormulaBtn">Search</button>
        <button id="clearBtn">Clear</button>
      </div>
      <div class="small muted" style="margin-top: 8px;">
        Tip: formula matching is exact here. If you want “contains” matching, tell me and I’ll switch it.
      </div>
    </div>

    <!-- SMILES search -->
    <div id="smilesBox" style="display:none;">
      <div class="row">
        <label for="smilesInput">SMILES</label>
        <input id="smilesInput" placeholder="e.g., O=C1OCCO1" style="flex: 1;" />
      </div>

      <div class="row" style="margin-top: 8px;">
        <label for="smilesCharge">Charge (optional)</label>
        <input id="smilesCharge" type="number" step="1" placeholder="e.g., 0" style="width: 120px;" />
      </div>

      <!-- (1) Spin removed entirely -->

      <div class="row" style="margin-top: 10px;">
        <button class="primary" id="searchSmilesBtn">Search</button>
        <button id="clearBtn2">Clear</button>
      </div>
      <div class="small muted" style="margin-top: 8px;">
        SMILES match is exact here (string equality). If you want canonicalization, we’d need a backend or a JS chem lib.
      </div>
    </div>

    <div class="hr"></div>

    <div style="font-weight: 600;">Results</div>
    <div class="row" style="margin-top: 8px;">
      <select id="resultsSelect" style="width: 100%;">
        <option value="">— No results —</option>
      </select>
    </div>

    <div class="row" style="margin-top: 10px;">
      <!-- (3) Download XYZ -->
      <button id="downloadXyzBtn" disabled>Download XYZ</button>
    </div>

    <div class="hr"></div>

    <div style="font-weight: 600;">Selected molecule</div>
    <div class="kvs" id="metaBox">
      <div class="muted">Status</div><div class="muted">No molecule selected.</div>
    </div>
  </section>

  <!-- Right: viewer + plot -->
  <section class="panel">
    <div class="row" style="justify-content: space-between;">
      <div style="font-weight: 600;">Structure</div>
      <div class="small muted" id="viewerNote"> </div>
    </div>
    <div id="viewer"></div>

    <div class="hr"></div>

    <div class="row" style="justify-content: space-between;">
      <div style="font-weight: 600;">IR spectrum</div>
      <div class="small muted" id="plotNote">Scaled frequencies shown.</div>
    </div>
    <div id="plot"></div>
  </section>
</main>

<script>
  // =========================
  // CONFIG: update this filename if needed
  // =========================
  const DATA_URL = "data.json"; // <-- if yours is different, change here

  // =========================
  // State
  // =========================
  let DB = [];             // array of molecule objects
  let currentMol = null;   // selected molecule object
  let viewer = null;       // 3Dmol viewer instance

  // =========================
  // DOM
  // =========================
  const statusPill = document.getElementById("statusPill");

  const searchMode = document.getElementById("searchMode");
  const formulaBox = document.getElementById("formulaBox");
  const smilesBox = document.getElementById("smilesBox");

  const formulaInput = document.getElementById("formulaInput");
  const formulaCharge = document.getElementById("formulaCharge");
  const smilesInput = document.getElementById("smilesInput");
  const smilesCharge = document.getElementById("smilesCharge");

  const searchFormulaBtn = document.getElementById("searchFormulaBtn");
  const searchSmilesBtn = document.getElementById("searchSmilesBtn");
  const clearBtn = document.getElementById("clearBtn");
  const clearBtn2 = document.getElementById("clearBtn2");

  const resultsSelect = document.getElementById("resultsSelect");
  const metaBox = document.getElementById("metaBox");

  const downloadXyzBtn = document.getElementById("downloadXyzBtn");
  const freqScale = document.getElementById("freqScale");

  // =========================
  // Helpers
  // =========================
  function safeInt(val) {
    if (val === "" || val === null || val === undefined) return null;
    const n = Number(val);
    return Number.isFinite(n) ? Math.trunc(n) : null;
  }

  function setStatus(text) {
    statusPill.textContent = text;
  }

  function clearResults() {
    resultsSelect.innerHTML = `<option value="">— No results —</option>`;
    currentMol = null;
    downloadXyzBtn.disabled = true;
    renderMeta(null);
    renderViewer(null);
    renderPlot(null);
  }

  function populateResults(matches) {
    if (!matches.length) {
      resultsSelect.innerHTML = `<option value="">— No results —</option>`;
      return;
    }

    const options = matches.map((m, idx) => {
      // These fields are used only for display — adjust if you prefer a different label
      const id = m.id ?? m.species_id ?? m.name ?? idx;
      const f = m.formula ?? "—";
      const q = (m.charge ?? "—");
      const sm = (m.smiles ?? "—");
      return `<option value="${idx}">${id} | ${f} | q=${q} | ${sm}</option>`;
    });

    resultsSelect.innerHTML = options.join("");
    resultsSelect.value = "0";
    selectFromMatches(matches, 0);
  }

  function selectFromMatches(matches, index) {
    const m = matches[index];
    currentMol = m;
    downloadXyzBtn.disabled = !Boolean(getXyzString(m));
    renderMeta(m);
    renderViewer(m);
    renderPlot(m);
  }

  function getXyzString(m) {
    // Change this if your xyz is stored under a different key
    // common variants: m.xyz, m.xyz_string, m.geometry_xyz
    return m?.xyz ?? m?.xyz_string ?? m?.geometry_xyz ?? null;
  }

  function getIrPeaks(m) {
    // Change this if your IR peaks are stored under a different key
    // expected format: [{freq: 1100.2, intensity: 25.1}, ...]
    // common variants: m.ir_peaks, m.ir, m.frequencies/intensities arrays, etc.
    return m?.ir_peaks ?? m?.ir ?? null;
  }

  function renderMeta(m) {
    if (!m) {
      metaBox.innerHTML = `<div class="muted">Status</div><div class="muted">No molecule selected.</div>`;
      return;
    }
    const id = m.id ?? m.species_id ?? m.name ?? "—";
    const formula = m.formula ?? "—";
    const smiles = m.smiles ?? "—";
    const charge = (m.charge ?? "—");
    const spin = (m.spin ?? m.multiplicity ?? "—"); // displayed if present, not searched on
    const nAtoms = m.num_atoms ?? m.natoms ?? m.number_atoms ?? "—";

    metaBox.innerHTML = `
      <div class="muted">ID</div><div>${id}</div>
      <div class="muted">Formula</div><div>${formula}</div>
      <div class="muted">SMILES</div><div style="word-break: break-all;">${smiles}</div>
      <div class="muted">Charge</div><div>${charge}</div>
      <div class="muted">Spin/Mult</div><div>${spin}</div>
      <div class="muted">Atoms</div><div>${nAtoms}</div>
    `;
  }

  // =========================
  // 3D viewer
  // =========================
  function initViewer() {
    viewer = $3Dmol.createViewer("viewer", { backgroundColor: "white" });
    viewer.zoomTo();
    viewer.render();
  }

  function renderViewer(m) {
    if (!viewer) initViewer();
    viewer.clear();

    if (!m) {
      viewer.render();
      return;
    }

    const xyz = getXyzString(m);
    if (!xyz) {
      viewer.render();
      return;
    }

    viewer.addModel(xyz, "xyz");
    viewer.setStyle({}, { stick: {}, sphere: { scale: 0.25 } });
    viewer.zoomTo();
    viewer.render();
  }

  // =========================
  // IR plotting
  // =========================
  function gaussian(x, mu, sigma) {
    const z = (x - mu) / sigma;
    return Math.exp(-0.5 * z * z);
  }

  function renderPlot(m) {
    const plotDiv = document.getElementById("plot");

    if (!m) {
      Plotly.newPlot(plotDiv, [], {
        margin: { l: 50, r: 20, t: 10, b: 45 },
        xaxis: { title: "Wavenumber (cm⁻¹)" },
        yaxis: { title: "Intensity (a.u.)" }
      }, {displayModeBar: true});
      return;
    }

    const peaks = getIrPeaks(m);
    if (!peaks || !peaks.length) {
      Plotly.newPlot(plotDiv, [], {
        margin: { l: 50, r: 20, t: 10, b: 45 },
        xaxis: { title: "Wavenumber (cm⁻¹)" },
        yaxis: { title: "Intensity (a.u.)" },
        annotations: [{
          text: "No IR peak data found for this molecule.",
          xref: "paper", yref: "paper", x: 0.5, y: 0.5, showarrow: false
        }]
      }, {displayModeBar: true});
      return;
    }

    // (4) Frequency scaling
    const scale = Number(freqScale.value) || 1.0;

    // If your peak objects use different keys, change `p.freq` and `p.intensity` here:
    const freqs = peaks.map(p => (p.freq ?? p.frequency ?? p.wavenumber) * scale);
    const intens = peaks.map(p => (p.intensity ?? p.ir_intensity ?? p.I));

    // simple spectrum from sticks -> gaussian broadening
    const minX = Math.max(0, Math.min(...freqs) - 200);
    const maxX = Math.max(...freqs) + 200;

    const N = 2500;
    const xs = new Array(N);
    const ys = new Array(N).fill(0);

    const sigma = 12; // cm^-1 broadening; adjust if you want
    for (let i = 0; i < N; i++) {
      xs[i] = minX + (maxX - minX) * (i / (N - 1));
    }
    for (let k = 0; k < freqs.length; k++) {
      const mu = freqs[k];
      const amp = intens[k];
      for (let i = 0; i < N; i++) {
        ys[i] += amp * gaussian(xs[i], mu, sigma);
      }
    }

    // normalize to 1 for visualization (common)
    const ymax = Math.max(...ys);
    const ysn = ys.map(v => ymax > 0 ? v / ymax : v);

    const traceSpectrum = {
      x: xs,
      y: ysn,
      mode: "lines",
      name: "Broadened spectrum"
    };

    const traceSticks = {
      x: freqs.flatMap(f => [f, f, null]),
      y: intens.flatMap(I => [0, I, null]),
      mode: "lines",
      name: "Sticks",
      yaxis: "y2"
    };

    Plotly.newPlot(plotDiv, [traceSpectrum, traceSticks], {
      margin: { l: 50, r: 20, t: 10, b: 45 },
      xaxis: { title: "Wavenumber (cm⁻¹)" },
      yaxis: { title: "Intensity (normalized)", rangemode: "tozero" },
      yaxis2: {
        title: "Stick intensity",
        overlaying: "y",
        side: "right",
        showgrid: false,
        rangemode: "tozero",
        showticklabels: false
      },
      legend: { orientation: "h" }
    }, {displayModeBar: true});
  }

  // =========================
  // Download XYZ
  // =========================
  function downloadXYZ(m) {
    const xyz = getXyzString(m);
    if (!xyz) return;

    const id = (m.id ?? m.species_id ?? m.name ?? "molecule").toString().replaceAll(" ", "_");
    const filename = `${id}.xyz`;

    const blob = new Blob([xyz], { type: "chemical/x-xyz;charset=utf-8" });
    const url = URL.createObjectURL(blob);

    const a = document.createElement("a");
    a.href = url;
    a.download = filename;
    document.body.appendChild(a);
    a.click();
    a.remove();

    URL.revokeObjectURL(url);
  }

  // =========================
  // Search logic
  // =========================
  function searchByFormula() {
    const f = (formulaInput.value || "").trim();
    const q = safeInt(formulaCharge.value);

    if (!f) {
      clearResults();
      return;
    }

    let matches = DB.filter(m => (m.formula ?? "").trim() === f);

    if (q !== null) {
      matches = matches.filter(m => safeInt(m.charge) === q);
    }

    // Store current matches on the select element (simple approach)
    resultsSelect._matches = matches;
    populateResults(matches);
  }

  function searchBySmiles() {
    const sm = (smilesInput.value || "").trim();
    const q = safeInt(smilesCharge.value);

    if (!sm) {
      clearResults();
      return;
    }

    let matches = DB.filter(m => (m.smiles ?? "").trim() === sm);

    // (1) only optional charge; no spin
    if (q !== null) {
      matches = matches.filter(m => safeInt(m.charge) === q);
    }

    resultsSelect._matches = matches;
    populateResults(matches);
  }

  // =========================
  // Events
  // =========================
  searchMode.addEventListener("change", () => {
    const mode = searchMode.value;
    if (mode === "formula") {
      formulaBox.style.display = "";
      smilesBox.style.display = "none";
    } else {
      formulaBox.style.display = "none";
      smilesBox.style.display = "";
    }
    clearResults();
  });

  searchFormulaBtn.addEventListener("click", searchByFormula);
  searchSmilesBtn.addEventListener("click", searchBySmiles);

  clearBtn.addEventListener("click", () => {
    formulaInput.value = "";
    formulaCharge.value = "";
    clearResults();
  });
  clearBtn2.addEventListener("click", () => {
    smilesInput.value = "";
    smilesCharge.value = "";
    clearResults();
  });

  resultsSelect.addEventListener("change", () => {
    const matches = resultsSelect._matches || [];
    const idx = Number(resultsSelect.value);
    if (!matches.length || !Number.isFinite(idx)) return;
    selectFromMatches(matches, idx);
  });

  downloadXyzBtn.addEventListener("click", () => {
    if (currentMol) downloadXYZ(currentMol);
  });

  // re-render plot when scale changes
  freqScale.addEventListener("change", () => {
    if (currentMol) renderPlot(currentMol);
  });

  // Enter key triggers search in active mode
  document.addEventListener("keydown", (e) => {
    if (e.key !== "Enter") return;
    if (searchMode.value === "formula") searchByFormula();
    else searchBySmiles();
  });

  // =========================
  // Load data
  // =========================
  async function loadData() {
    setStatus("Loading data…");
    try {
      const resp = await fetch(DATA_URL);
      if (!resp.ok) throw new Error(`Failed to fetch ${DATA_URL}: ${resp.status}`);
      const json = await resp.json();

      // If your JSON is {molecules: [...]}, adapt here:
      DB = Array.isArray(json) ? json : (json.molecules ?? json.data ?? []);

      setStatus(`Loaded ${DB.length} molecules`);
      clearResults();

      // (2) Default search mode is formula — already selected in HTML
      formulaBox.style.display = "";
      smilesBox.style.display = "none";
    } catch (err) {
      console.error(err);
      setStatus("Error loading data");
      metaBox.innerHTML = `<div class="muted">Error</div><div class="muted" style="word-break: break-all;">${err.message}</div>`;
    }
  }

  initViewer();
  loadData();
</script>
</body>
</html>
